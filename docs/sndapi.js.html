<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Documentation Source: C:/Users/ikari/code/sndapi-js/src/sndapi.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cerulean.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">Documentation</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="SNDAPI.html">SNDAPI</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: C:/Users/ikari/code/sndapi-js/src/sndapi.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript ">/*global global,ActiveXObject */
//noinspection ThisExpressionReferencesGlobalObjectJS
/*
 * Schibsted Norge Digital API client helper library.
 *
 * This file is library/framework independent. No runtime dependencies.

 * If JSON is defined, responses sent with mime type application/json will be parsed automatically.
 */

// wrapper for global
/**
 * @namespace
 */
(function(global) {
    "use strict";

    function SchönfinkelizedResult() {
        // instance properties
        var me = {
            _onSuccess: [],
            _onError  : []
        };

        return me;
    }

    /**
     * Add success callback to the AJAX call
     * @param callback
     * @returns {*}
     */
    SchönfinkelizedResult.prototype.success = function(callback) {
        this._onSuccess.push(callback);
        return this;
    };

    /**
     * Add fail (error) callback to the AJAX call
     * @param callback
     * @returns {*}
     */
    SchönfinkelizedResult.prototype.fail = function(callback) {
        this._onError.push(callback);
        return this;
    };

    SchönfinkelizedResult.prototype.resolve = function() {
        var cb;
        while (!!(cb = this._onSuccess.shift())) {
            cb.apply(this, arguments);
        }
        return this;
    };

    SchönfinkelizedResult.prototype.reject = function() {
        var cb;
        while (!!(cb = this._onError.shift())) {
            cb.apply(this, arguments);
        }
        return this;
    };

    SchönfinkelizedResult.prototype.propagateTo = function(otherResult) {
        this._onSuccess = this._onSuccess.concat(otherResult._onSuccess);
        this._onError = this._onError.concat(otherResult._onError);
        return this;
    };


    /**
     * Public API of the SND news API client. Registers as global SNDAPI constructor.
     * @constructor
     * @alias SNDAPI
     * @param options {object} Options object
     * @param options.refreshInterval {number?} Interval of signature refresh, defaults to 30 minutes
     * @param options.signatureServiceUrl {string?} URL for the signature service
     * @param options.prefixUrl {string?} Common prefix for all URLs called later by the API (you can use partial URLs later)
     * @param options.key {string} API key of your client
     */
    global.SNDAPI = global.SNDAPI || function(options) {
        var apiOptions = mergeOptions({
                refreshInterval    : 30 * /*minutes*/6e4,
                signatureServiceUrl: "https://api.snd.no/sts/signature",
                prefixUrl          : "http://api.snd.no/news/v2/",
                key                : null
            }, options),
            publicApi,

            state = {
                token     : null,
                tokenTimer: null
            },
            queue = [];

        /**
         * Fetches an object representing the current state of the library.
         * @memberOf SNDAPI
         * @public
         * @instance
         * @returns {{tokenIsSet: boolean, tokenTimerIsSet: boolean}}
         */
        function getState() {
            return {
                /**
                 * is the token/signature set (received correctly from the server?)
                 */
                tokenIsSet     : !!(state.token),
                /**
                 * tells if the timer to refresh token automatically is set correctly (for debug)
                 */
                tokenTimerIsSet: !!(state.tokenTimer)
            };
        }

        /**
         * initializes the SND API and fetches a new token from the server
         * @memberOf SNDAPI
         * @instance
         */
        function init() {
            if (!apiOptions.key) {
                throw new Error("API key is required for SND API initalization");
            }
            if (state.tokenTimer) { clearInterval(state.tokenTimer); }
            state.tokenTimer = setInterval(refreshToken, apiOptions.refreshInterval);
            return refreshToken();
        }

        /**
         * refreshes the token/signature contacting the signature service
         * @returns {*}
         */
        function refreshToken() {
            return ajax({
                sign: false,
                url : apiOptions.signatureServiceUrl + "?api-key=" + apiOptions.key
            })
                .success(function(response, statusDetails) {
                    var request;
                    state.token = response.token;

                    if (queue.length) {
                        while ((request = queue.shift())) {
                            ajax(request.options).propagateTo(request.result);
                        }
                    }
                })
                .fail(function(error) {
                    // TODO handle it? or leave it to the user?
                });
        }

        /**
         * Overwrite default options with given ones and return them in a new object (shallow copying here).
         * @param defaults {object} Your map of default values for options
         * @param given {object?} Options given in this particular method call, can be undefined
         * @returns {object} A new object with shallow copy of defaults overwritten with shallow copy of given options
         * @private
         * @instance
         */
        function mergeOptions(defaults, given) {
            var key, result = {}, hop = Object.hasOwnProperty;
            for (key in defaults) {
                if (hop.call(defaults, key)) {
                    //noinspection JSUnfilteredForInLoop
                    result[key] = defaults[key];
                }
            }
            if (typeof given === "object") {
                for (key in given) {
                    if (hop.call(given, key)) {
                        //noinspection JSUnfilteredForInLoop
                        result[key] = given[key];
                    }
                }
            }
            return result;
        }

        /**
         * Make an AJAX call for any data
         * @param options {object} request parameters
         * @param options.url {object} request URL, will be prefixed with prefixUrl passed to constructor if relative
         * @param options.postData {object?} data that will be sent as POST body
         * @param [options.preferJSON=true] (boolean) do we want to add header asking politely for JSON content-type?
         * @param [options.sign=true] {boolean} sign this request with the x-snd-apisignature header
         * @memberOf SNDAPI
         * @instance
         * @returns {SchönfinkelizedResult} a promise
         */
        function ajax(options) {
            var requestOptions = mergeOptions({
                    // the defaults:
                    url       : null,
                    postData  : null,
                    preferJSON: true,
                    sign      : true
                }, options),
                req = createXMLHTTPObject(),
                method = (requestOptions.postData) ? "POST" : "GET",

                status = null,
                statusDetails = {
                    response: null
                },
                result = new SchönfinkelizedResult();


            if (!/^http/.test(requestOptions.url)) {
                // prepend the standard prefix
                requestOptions.url = apiOptions.prefixUrl + requestOptions.url;
            }


            function resolve() {
                if (status === "success") {
                    result.resolve(statusDetails.response, statusDetails);
                    return resolveAndReturn();
                } else {
                    result.reject(statusDetails);
                    return resolveAndReturn();
                }
            }

            function resolveAndReturn() {
                if (status) { resolve(); }
                return result;
            }


            if (!req) {
                status = "fail";
                return result;
            }
            result.req = req; // publish the object, why not


            // queue if we are not ready
            if (!state.token &amp;&amp; requestOptions.sign) {
                queue.push({
                    options: requestOptions,
                    result : result
                });
                return result;
            }


            // otherwise make the request
            req.open(method, requestOptions.url, true);

            // no idea why this was in stackOverflow code
            // req.setRequestHeader('User-Agent', 'XMLHTTP/1.0');

            // adding signature
            if (state.token &amp;&amp; requestOptions.sign) { req.setRequestHeader('X-Snd-Apisignature', state.token); }
            if (requestOptions.postData) { req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded'); }
            if (requestOptions.preferJSON) {
                req.setRequestHeader('Accept', 'application/json');
            }

            req.onreadystatechange = function() {
                if (req.readyState !== 4) { return; }
                if (req.status !== 200 &amp;&amp; req.status !== 304) {
                    status = "fail";
                    statusDetails = {
                        statusCode: req.status,
                        statusText: req.statusText,
                        response  : req.responseText
                    };
                } else {
                    status = "success";
                    statusDetails = {
                        statusCode: req.status,
                        statusText: req.statusText,
                        response  : req.responseText
                    };
                    if (req.getResponseHeader("Content-Type").match(/^application\/json/) &amp;&amp; JSON) {
                        statusDetails.response = JSON.parse(statusDetails.response);
                    }
                }
                resolve();
            };
            if (req.readyState === 4) {
                if (global.console) {global.console.warn("I did not expect to get here");}
                return null;
            }
            req.send(requestOptions.postData);

            return result;
        }

        var XMLHttpFactories = [
            function() {return new XMLHttpRequest();},
            function() {return new ActiveXObject("Msxml2.XMLHTTP");},
            function() {return new ActiveXObject("Msxml3.XMLHTTP");},
            function() {return new ActiveXObject("Microsoft.XMLHTTP");}
        ];

        function createXMLHTTPObject() {
            var XmlHttp = false;
            for (var i = 0; i &lt; XMLHttpFactories.length; i++) {
                try { XmlHttp = XMLHttpFactories[i](); }
                catch (e) { continue; }
                break;
            }
            return XmlHttp;
        }

        publicApi = {
            init    : init,
            getState: getState,
            ajax    : ajax
        };

        return publicApi;
    };

})(typeof global === "object" ? global : this);

/*global module,SNDAPI */
if (typeof module !== 'undefined' &amp;&amp; module.exports) {
    module.exports = SNDAPI;
}</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a>
		on Wed Apr 09 2014 10:33:42 GMT+0200 (Central European Daylight Time) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
